# METABEGIN
# X-Env-Layer-Name: example-mydevice
# X-Env-Layer-Category: example
# X-Env-Layer-Desc: Example device layer that performs some fine tuning using
#  dpkg to trim files so we boot a v8 kernel on pi5 / cm5 only. Declares the
#  asset dir so that overlays and hooks will be found.
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: device-base
# X-Env-Layer-Provides: device
#
# X-Env-VarPrefix: device
#
# X-Env-Var-assetdir: ${DIRECTORY}
# X-Env-Var-assetdir-Desc: Directory for device assets
# X-Env-Var-assetdir-Required: n
# X-Env-Var-assetdir-Valid: string
# X-Env-Var-assetdir-Set: y

# METAEND
---
mmdebstrap:
  packages:
    - raspi-firmware
    - linux-image-rpi-v8
    - firmware-brcm80211
  dpkgopts:
    - path-exclude=/usr/lib/raspi-firmware/*
    - path-include=/usr/lib/raspi-firmware/LICENCE.broadcom
    - path-exclude=/usr/lib/linux-image-*-v8/broadcom/bcm2710*
    - path-exclude=/usr/lib/linux-image-*-v8/broadcom/bcm2711*
    - path-exclude=/usr/lib/linux-image-*-v8/broadcom/bcm2837*
    - path-exclude=/usr/share/doc/firmware-brcm80211/
    - path-include=/usr/share/doc/firmware-brcm80211/copyright
    - path-exclude=/lib/firmware/cypress/*
    - path-include=/lib/firmware/cypress/cyfmac43455*
    - path-exclude=/lib/firmware/brcm/*
    - path-include=/lib/firmware/brcm/brcmfmac43455-sdio.raspberrypi,5*
    - path-include=/lib/firmware/brcm/brcmfmac43455-sdio.txt
    - path-include=/lib/firmware/brcm/BCM4345C0.raspberrypi,5*
  customize-hooks:
    - mkdir -p $1/boot/firmware
    - ln -sf firmware/overlays $1/boot/overlays
    - install -m 644 ${IGconf_device_assetdir}/cmdline.txt $1/boot/firmware/
    - install -m 644 ${IGconf_device_assetdir}/config.txt $1/boot/firmware/
